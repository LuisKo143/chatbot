<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Freier Text+Bild Chatbot</title>
<style>
  body { font-family: system-ui,sans-serif; margin:0; display:grid; grid-template-rows:auto 1fr auto; height:100vh;}
  header { padding:12px 16px; background:#f5f5f5; display:flex; justify-content:space-between; align-items:center;}
  main {
  display: flex;
  height: calc(100vh - 60px); /* Header + Footer berücksichtigen */
  overflow: hidden; /* verhindert, dass Scrollbars doppelt erscheinen */
}

#chat-section, #image-section {
  flex: 1;
  min-width: 0; /* sehr wichtig für flexbox, sonst Inhalt kann nicht schrumpfen */
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#log {
  flex: 1;            /* Chatbereich füllt den verfügbaren Platz */
  overflow-y: auto;   /* scrollen wenn nötig */
  padding: 16px;
}

#composer {
  flex-shrink: 0;     /* Inputfeld immer sichtbar */
}

  .msg { margin-bottom:12px; }
  .user { font-weight:bold; color:#0066cc; }
  .assistant { font-weight:bold; color:#009933; }
  form { display:grid; grid-template-columns:1fr auto; gap:8px; padding:12px 16px; border-top:1px solid #ddd;}
  textarea { resize: vertical; min-height:60px; padding:10px; }
  button { padding:10px 16px; border-radius:8px; border:none; background:#0066cc; color:white; font-weight:bold; cursor:pointer;}
  button:disabled { opacity:0.6; cursor:wait;}
  #image-output img { max-width:100%; margin-bottom:12px; border-radius:8px; border:1px solid #ccc;}
</style>
<script type="importmap">
{
  "imports": {
    "webllm":"https://esm.run/@mlc-ai/web-llm",
    "websd":"https://esm.run/@mlc-ai/web-sd"
  }
}
</script>
</head>
<body>

<header>
  <strong>Freier Text+Bild Chatbot</strong>
  <div>
    <select id="model">
      <option value="Llama-3-7B-Base-MLC">Llama 3 7B Base</option>
      <option value="Phi-3-mini-Base-4k-MLC">Phi-3 Mini Base</option>
    </select>
  </div>
</header>

<main>
  <div id="chat-section">
    <div id="log"></div>
    <form id="composer">
      <textarea id="prompt" placeholder="Frag mich oder tippe /image …" required></textarea>
      <button id="send">Senden</button>
    </form>
  </div>
  <div id="image-section">
    <div id="image-output"></div>
  </div>
</main>

<script type="module">
import * as webllm from "webllm";
import * as websd from "websd";

const log=document.getElementById("log");
const form=document.getElementById("composer");
const promptEl=document.getElementById("prompt");
const modelSel=document.getElementById("model");
const sendBtn=document.getElementById("send");
const imgOutput=document.getElementById("image-output");

let engine;
let chatHistory=[];

function addMsg(role,text){
  const div=document.createElement("div");
  div.className="msg";
  div.innerHTML=`<span class="${role}">${role==="user"?"Du":"Bot"}:</span> ${text}`;
  log.appendChild(div);
  log.scrollTop=log.scrollHeight;
}

async function initModel(){
  const modelId=modelSel.value;
  addMsg("assistant",`⏳ Lade Modell: ${modelId} ...`);
  engine=await webllm.CreateMLCEngine(modelId,{initProgressCallback:info=>console.log(info)});
  chatHistory=[];
  addMsg("assistant",`✅ Modell "${modelId}" bereit!`);
}

modelSel.addEventListener("change",()=>initModel());
initModel();

// Init SD Engine
let sdEngine;
async function initSD(){
  sdEngine=await websd.CreateEngine("stable-diffusion-1.5-base",{progressCallback:info=>console.log("SD:",info)});
}
initSD();

// Chat + Bild-Command Handler
form.addEventListener("submit",async e=>{
  e.preventDefault();
  const text=promptEl.value.trim();
  if(!text||!engine)return;
  promptEl.value="";
  addMsg("user",text);
  sendBtn.disabled=true;

  // Prüfe auf /image Command
  if(text.startsWith("/image")){
    const imgPrompt=text.replace("/image","").trim();
    addMsg("assistant",`⏳ Generiere Bild: "${imgPrompt}" ...`);
    if(sdEngine){
      const imgData=await sdEngine.generate({prompt:imgPrompt,width:512,height:512,steps:20});
      const imgEl=document.createElement("img");
      imgEl.src=imgData;
      imgOutput.prepend(imgEl);
      addMsg("assistant","✅ Bild generiert!");
    } else addMsg("assistant","❌ SD Engine nicht bereit.");
    sendBtn.disabled=false;
    return;
  }

  // Normaler Chat
  const replyChunks=[];
  await engine.chat.completions.create({
    messages:[...chatHistory,{role:"user",content:text}],
    stream:true
  }).then(async stream=>{
    for await(const part of stream){
      const delta=part.choices[0]?.delta?.content||"";
      if(delta){
        replyChunks.push(delta);
        addOrUpdateAssistant(replyChunks.join(""));
      }
    }
  });
  const fullReply=replyChunks.join("");
  chatHistory.push({role:"user",content:text});
  chatHistory.push({role:"assistant",content:fullReply});
  sendBtn.disabled=false;
});

function addOrUpdateAssistant(text){
  let last=log.lastElementChild;
  if(!last||!last.querySelector(".assistant")) addMsg("assistant",text);
  else last.innerHTML=`<span class="assistant">Bot:</span> ${text}`;
}
</script>

</body>
</html>
